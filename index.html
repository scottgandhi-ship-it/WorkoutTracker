<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="531 Tracker">
  <meta name="theme-color" content="#101012">
  <link rel="manifest" href="manifest.json">
  <title>531 Tracker</title>
  <style>
    /* ===== RESET & BASE ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #101012; --card: #1c1c1f; --card-border: rgba(255,255,255,0.06);
      --accent: #5b9aff; --accent-dim: rgba(91,154,255,0.15); --accent-glow: rgba(91,154,255,0.25);
      --success: #5cd6a0; --success-dim: rgba(92,214,160,0.12);
      --warning: #f0c050; --warning-dim: rgba(240,192,80,0.12);
      --danger: #f07070; --danger-dim: rgba(240,112,112,0.12);
      --text: #ebebef; --text-secondary: #9a9aa8;
      --muted: #6e6e80; --input-bg: #1c1c1f;
      --surface-elevated: #242428;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --radius-sm: 10px; --radius-md: 14px; --radius-lg: 18px;
      --shadow-card: 0 1px 4px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.04);
      --shadow-elevated: 0 4px 16px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.05);
      --transition: 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    html, body { height: 100%; overflow: hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro', 'Segoe UI', system-ui, sans-serif;
      background: var(--bg); color: var(--text); font-size: 15px; line-height: 1.5;
      -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent;
    }

    /* ===== APP SHELL ===== */
    .app { display: flex; flex-direction: column; height: 100%; }
    .header {
      padding: calc(var(--safe-top) + 16px) 20px 14px;
      background: rgba(28,28,31,0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      display: flex; justify-content: space-between; align-items: center;
      flex-shrink: 0; z-index: 50;
      box-shadow: 0 1px 0 rgba(255,255,255,0.04);
    }
    .header h1 { font-size: 22px; font-weight: 800; letter-spacing: -0.6px; }
    .header .cycle-badge {
      font-size: 12px; background: var(--accent-dim); color: var(--accent);
      padding: 5px 12px; border-radius: 20px; font-weight: 700; letter-spacing: 0.2px;
    }
    .main-content {
      flex: 1; overflow-y: auto; overflow-x: hidden;
      padding: 20px 20px calc(var(--safe-bottom) + 80px);
      -webkit-overflow-scrolling: touch;
    }
    .tab-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(28,28,31,0.82); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
      display: flex; padding-bottom: var(--safe-bottom);
      z-index: 100; flex-shrink: 0;
      box-shadow: 0 -1px 12px rgba(0,0,0,0.3);
    }
    .tab-btn {
      flex: 1; display: flex; flex-direction: column; align-items: center;
      padding: 10px 0 6px; border: none; background: none; color: var(--muted);
      font-size: 10px; font-weight: 600; cursor: pointer; transition: color var(--transition);
      -webkit-tap-highlight-color: transparent;
    }
    .tab-btn.active { color: var(--accent); }
    .tab-btn svg { width: 26px; height: 26px; margin-bottom: 3px; transition: transform var(--transition); }
    .tab-btn:active svg { transform: scale(0.9); }
    .view { display: none; animation: fadeIn 0.25s ease; }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

    /* ===== COMMON COMPONENTS ===== */
    .card {
      background: var(--card); border: none;
      border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px;
      box-shadow: var(--shadow-card);
      transition: transform var(--transition);
    }
    .card:active { transform: scale(0.995); }
    .card-title {
      font-size: 11px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.8px; color: var(--muted); margin-bottom: 12px;
    }
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 14px 22px; border-radius: var(--radius-md); border: none; font-size: 15px;
      font-weight: 600; cursor: pointer; transition: all var(--transition); width: 100%;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:active { opacity: 0.85; transform: scale(0.97); }
    .btn-success { background: var(--success); color: #111; }
    .btn-success:active { opacity: 0.85; transform: scale(0.97); }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-danger:active { opacity: 0.85; transform: scale(0.97); }
    .btn-outline { background: var(--surface-elevated); border: 1px solid var(--card-border); color: var(--text); }
    .btn-outline:active { background: rgba(255,255,255,0.08); transform: scale(0.97); }
    .btn-sm { padding: 10px 16px; font-size: 13px; width: auto; border-radius: var(--radius-sm); }
    input[type="number"], input[type="text"], select {
      background: var(--surface-elevated); border: 1px solid var(--card-border); color: var(--text);
      border-radius: var(--radius-sm); padding: 12px 14px; font-size: 15px; width: 100%;
      -webkit-appearance: none; appearance: none;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    input[type="number"]:focus, input[type="text"]:focus, select:focus {
      outline: none; border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    input[type="number"] { text-align: center; }
    select { cursor: pointer; }

    /* ===== DAY SELECTOR ===== */
    .day-selector { display: flex; gap: 8px; margin-bottom: 20px; }
    .day-btn {
      flex: 1; padding: 12px 4px; border: none;
      border-radius: var(--radius-md); background: var(--card); color: var(--text-secondary);
      font-size: 11px; font-weight: 600; text-align: center; cursor: pointer;
      transition: all var(--transition); line-height: 1.3;
      box-shadow: var(--shadow-card);
    }
    .day-btn:active { transform: scale(0.95); }
    .day-btn.active { background: var(--accent-dim); color: var(--accent); box-shadow: 0 0 0 1.5px var(--accent), var(--shadow-card); }
    .day-btn .day-num { font-size: 13px; font-weight: 800; display: block; color: var(--text); }

    /* ===== SETS TABLE ===== */
    .sets-section { margin-top: 14px; }
    .sets-label { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; letter-spacing: 0.8px; }
    .set-row {
      display: flex; align-items: center; padding: 13px 0;
      border-bottom: 1px solid var(--card-border);
    }
    .set-row:last-child { border-bottom: none; }
    .set-num {
      width: 30px; height: 30px; font-size: 12px; color: var(--muted); font-weight: 700;
      display: flex; align-items: center; justify-content: center;
      background: var(--surface-elevated); border-radius: 50%; flex-shrink: 0;
    }
    .set-weight { flex: 1; font-size: 17px; font-weight: 700; margin-left: 12px; letter-spacing: -0.2px; }
    .set-reps { width: 54px; text-align: center; font-size: 13px; color: var(--text-secondary); font-weight: 500; }
    .set-reps.amrap { color: var(--warning); font-weight: 700; }
    .amrap-input {
      width: 58px; padding: 8px; text-align: center; font-size: 16px;
      font-weight: 700; background: var(--warning-dim); border: 1.5px solid var(--warning);
      border-radius: var(--radius-sm); color: var(--warning);
      transition: box-shadow var(--transition);
    }
    .amrap-input:focus { box-shadow: 0 0 0 3px rgba(240,192,80,0.2); }
    .set-check {
      width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.1);
      background: none; color: transparent; display: flex; align-items: center;
      justify-content: center; cursor: pointer; transition: all var(--transition); flex-shrink: 0;
      margin-left: 10px; font-size: 16px;
    }
    .set-check:active { transform: scale(0.9); }
    .set-check.done { background: var(--success); border-color: var(--success); color: #111; }

    /* ===== ACCESSORY SECTION ===== */
    .acc-item { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--card-border); }
    .acc-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .acc-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .acc-name { font-size: 15px; font-weight: 700; letter-spacing: -0.2px; }
    .acc-target { font-size: 12px; color: var(--muted); font-weight: 600; background: var(--surface-elevated); padding: 3px 8px; border-radius: 6px; }
    .acc-last { font-size: 12px; color: var(--accent); margin-top: 3px; font-weight: 500; }
    .acc-set-table { width: 100%; margin-top: 6px; }
    .acc-set-row { display: flex; align-items: center; gap: 8px; padding: 4px 0; }
    .acc-set-label { width: 24px; font-size: 11px; color: var(--muted); font-weight: 700; flex-shrink: 0; }
    .acc-input {
      height: 38px; border-radius: 8px; border: 1px solid var(--card-border);
      background: var(--surface-elevated); color: var(--text); font-size: 14px; font-weight: 600;
      text-align: center; padding: 0 6px;
      transition: border-color var(--transition), box-shadow var(--transition), background var(--transition);
    }
    .acc-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
    .acc-input.wt { width: 68px; }
    .acc-input.rp { width: 48px; }
    .acc-input.filled { background: var(--success-dim); border-color: rgba(92,214,160,0.3); color: var(--success); }
    .acc-set-x { font-size: 11px; color: var(--muted); flex-shrink: 0; }
    .acc-timer-btn {
      width: 100%; height: 40px; border-radius: var(--radius-sm); border: 1px solid var(--card-border);
      background: var(--surface-elevated); color: var(--text-secondary); font-size: 13px; font-weight: 600;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all var(--transition); margin-top: 8px;
    }
    .acc-timer-btn:active { background: var(--accent-dim); color: var(--accent); border-color: rgba(91,154,255,0.3); transform: scale(0.97); }
    .acc-suggestion { font-size: 12px; color: var(--success); margin-top: 6px; font-weight: 600; }

    /* ===== QUICK LOG ===== */
    .quick-log-link {
      display: block; text-align: center; margin-top: 16px;
      color: var(--muted); font-size: 13px; font-weight: 600;
      cursor: pointer; padding: 10px; transition: color var(--transition);
    }
    .quick-log-link:active { color: var(--accent); }
    .ql-field { margin-bottom: 16px; }
    .ql-field label { display: block; font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
    .ql-day-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .ql-day-btn {
      flex: 1; min-width: 0; padding: 10px 4px; border: none;
      border-radius: var(--radius-sm); background: var(--surface-elevated); color: var(--text-secondary);
      font-size: 12px; font-weight: 600; text-align: center; cursor: pointer; transition: all var(--transition);
    }
    .ql-day-btn:active { transform: scale(0.95); }
    .ql-day-btn.active { background: var(--accent-dim); color: var(--accent); box-shadow: 0 0 0 1.5px var(--accent); }
    .ql-week-grid { display: flex; gap: 8px; }
    .ql-week-btn {
      flex: 1; padding: 10px; border: none;
      border-radius: var(--radius-sm); background: var(--surface-elevated); color: var(--text-secondary);
      font-size: 12px; font-weight: 600; text-align: center; cursor: pointer; transition: all var(--transition);
    }
    .ql-week-btn:active { transform: scale(0.95); }
    .ql-week-btn.active { background: var(--accent-dim); color: var(--accent); box-shadow: 0 0 0 1.5px var(--accent); }
    .ql-summary {
      background: var(--surface-elevated); border-radius: var(--radius-md); padding: 14px;
      margin-bottom: 16px; font-size: 14px; line-height: 1.6;
    }
    .ql-summary .lift-name { font-weight: 700; color: var(--accent); }
    .ql-summary .top-set { color: var(--warning); font-weight: 700; }
    .ql-badge {
      display: inline-block; font-size: 10px; font-weight: 700; padding: 3px 8px;
      border-radius: 6px; background: var(--accent-dim); color: var(--accent); margin-left: 6px; vertical-align: middle;
    }

    /* ===== HISTORY ===== */
    .history-item { cursor: pointer; transition: all var(--transition); border-left: 3px solid transparent; }
    .history-item:active { background: var(--surface-elevated); }
    .history-header { display: flex; justify-content: space-between; align-items: center; }
    .history-date { font-size: 12px; color: var(--muted); font-weight: 500; }
    .history-day { font-size: 16px; font-weight: 700; margin-top: 3px; letter-spacing: -0.2px; }
    .history-lift { font-size: 14px; color: var(--accent); margin-top: 4px; font-weight: 500; }
    .history-detail {
      display: none; margin-top: 12px; padding-top: 12px;
      border-top: 1px solid var(--card-border); font-size: 13px;
      animation: fadeIn 0.2s ease;
    }
    .history-detail.open { display: block; }
    .pr-badge { display: inline-block; background: var(--warning); color: #111; font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 6px; margin-left: 6px; }

    /* ===== PROGRESS ===== */
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .stat-card { text-align: center; padding: 20px 16px; }
    .stat-card .stat-value { font-size: 34px; font-weight: 800; color: var(--accent); letter-spacing: -1px; }
    .stat-card .stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: 700; margin-top: 4px; letter-spacing: 0.5px; }
    .projection-table { width: 100%; font-size: 13px; border-collapse: collapse; }
    .projection-table th {
      text-align: left; padding: 10px 8px; font-size: 10px; text-transform: uppercase;
      color: var(--muted); border-bottom: 1px solid var(--card-border); font-weight: 700; letter-spacing: 0.5px;
    }
    .projection-table td { padding: 10px 8px; border-bottom: 1px solid var(--card-border); }
    .projection-table tr:last-child td { border-bottom: none; }
    .projection-table tr:nth-child(even) td { background: rgba(255,255,255,0.015); }
    .trend-up { color: var(--success); font-weight: 600; }
    .trend-same { color: var(--muted); }
    .chart-container { position: relative; width: 100%; margin-bottom: 10px; }
    .chart-container canvas { width: 100%; height: 280px; display: block; border-radius: var(--radius-md); }
    .chart-legend { display: flex; flex-wrap: wrap; gap: 14px; margin-top: 10px; justify-content: center; }
    .chart-legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; }
    .chart-legend-dot { width: 10px; height: 10px; border-radius: 50%; }
    .time-toggle { display: flex; gap: 4px; background: var(--surface-elevated); border-radius: var(--radius-sm); padding: 3px; margin-bottom: 16px; }
    .time-toggle-btn {
      flex: 1; padding: 8px 4px; border: none; border-radius: 8px;
      background: none; color: var(--text-secondary); font-size: 13px; font-weight: 600;
      cursor: pointer; transition: all var(--transition); text-align: center;
    }
    .time-toggle-btn:active { transform: scale(0.95); }
    .time-toggle-btn.active { background: var(--accent-dim); color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }

    /* ===== SETTINGS ===== */
    .setting-group { margin-bottom: 24px; }
    .setting-label { font-size: 11px; font-weight: 700; color: var(--muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .setting-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .setting-row label { flex: 1; font-size: 15px; font-weight: 500; }
    .setting-row input { width: 84px; height: 44px; }
    .setting-row select { width: 130px; height: 44px; }
    .inline-btns { display: flex; gap: 10px; margin-top: 14px; }
    .inline-btns .btn { flex: 1; }

    /* ===== TIMER BANNER ===== */
    .timer-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0;
      padding: calc(var(--safe-top) + 12px) 20px 12px;
      background: rgba(28,28,31,0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-bottom: none; box-shadow: 0 2px 16px rgba(0,0,0,0.4);
      z-index: 200; align-items: center; justify-content: center; gap: 16px;
    }
    .timer-overlay.show { display: flex; }
    body.timer-active .main-content { padding-top: 64px; }
    .timer-display { font-size: 32px; font-weight: 800; font-variant-numeric: tabular-nums; min-width: 72px; text-align: center; letter-spacing: -0.5px; }
    .timer-label { display: none; }
    .timer-btns { display: flex; gap: 10px; }
    .timer-btns .btn { width: auto; padding: 8px 16px; font-size: 13px; border-radius: 20px; }

    /* ===== WEEK SELECTOR ===== */
    .week-selector { display: flex; gap: 8px; margin-bottom: 20px; }
    .week-btn {
      flex: 1; padding: 10px; border: none;
      border-radius: var(--radius-sm); background: var(--card); color: var(--text-secondary);
      font-size: 12px; font-weight: 600; text-align: center; cursor: pointer;
      transition: all var(--transition); box-shadow: var(--shadow-card);
    }
    .week-btn:active { transform: scale(0.95); }
    .week-btn.active { background: var(--accent-dim); color: var(--accent); box-shadow: 0 0 0 1.5px var(--accent), var(--shadow-card); }
    .week-btn.done { background: var(--success-dim); color: var(--success); box-shadow: 0 0 0 1px rgba(92,214,160,0.3); }

    /* ===== MODAL ===== */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      z-index: 300; align-items: center;
      justify-content: center; padding: 24px;
    }
    .modal-overlay.show { display: flex; animation: fadeIn 0.2s ease; }
    .modal {
      background: var(--card); border-radius: 20px; padding: 28px; width: 100%;
      max-width: 380px; max-height: calc(100vh - 48px); overflow-y: auto;
      box-shadow: var(--shadow-elevated);
      animation: modalIn 0.25s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    .modal h3 { font-size: 20px; font-weight: 800; margin-bottom: 16px; letter-spacing: -0.3px; }
    .modal .btn { margin-top: 12px; }

    /* ===== EMPTY STATE ===== */
    .empty-state { text-align: center; padding: 60px 24px; color: var(--muted); }
    .empty-state svg { width: 52px; height: 52px; margin-bottom: 16px; opacity: 0.2; }
    .empty-state p { font-size: 15px; line-height: 1.6; }

    /* ===== MISC ===== */
    .divider { height: 1px; background: var(--card-border); margin: 20px 0; }
    .text-muted { color: var(--muted); }
    .text-accent { color: var(--accent); }
    .text-success { color: var(--success); }
    .text-warning { color: var(--warning); }
    .text-sm { font-size: 13px; }
    .text-xs { font-size: 11px; }
    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .mb-8 { margin-bottom: 8px; }
    .mb-16 { margin-bottom: 16px; }
    .fw-700 { font-weight: 700; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
    ::selection { background: var(--accent-glow); }
    ::-webkit-scrollbar { width: 0; background: transparent; }

    /* ===== TEMPLATE SELECTOR ===== */
    .template-current { font-size: 15px; color: var(--accent); font-weight: 700; margin-bottom: 4px; }
    .template-grid { display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; margin-bottom: 14px; }
    .template-card {
      padding: 16px; border: 1.5px solid var(--card-border); border-radius: var(--radius-md);
      cursor: pointer; transition: all var(--transition); background: var(--surface-elevated);
    }
    .template-card:active { transform: scale(0.98); }
    .template-card.selected { border-color: var(--accent); background: var(--accent-dim); box-shadow: 0 0 0 3px var(--accent-glow); }
    .template-card-name { font-size: 16px; font-weight: 700; letter-spacing: -0.2px; }
    .template-card-desc { font-size: 13px; color: var(--text-secondary); margin-top: 4px; line-height: 1.4; }
    .template-card-days { font-size: 12px; color: var(--accent); margin-top: 6px; font-weight: 600; }

    /* ===== SUPPLEMENTAL SETS ===== */
    .supplemental-label { color: var(--warning); }
    .supp-badge { display: inline-block; font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 6px; background: var(--warning); color: #111; margin-left: 6px; vertical-align: middle; }
  </style>
</head>
<body>
  <div class="app">
    <!-- HEADER -->
    <div class="header">
      <h1>531 Tracker</h1>
      <div class="cycle-badge" id="cycleBadge">W1 / C1</div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content" id="mainContent">

      <!-- ===== WORKOUT VIEW ===== -->
      <div class="view active" id="viewWorkout">
        <div class="week-selector" id="weekSelector"></div>
        <div class="day-selector" id="daySelector"></div>
        <div id="workoutContent"></div>
      </div>

      <!-- ===== HISTORY VIEW ===== -->
      <div class="view" id="viewHistory">
        <div id="historyContent"></div>
      </div>

      <!-- ===== PROGRESS VIEW ===== -->
      <div class="view" id="viewProgress">
        <div id="progressContent"></div>
      </div>

      <!-- ===== SETTINGS VIEW ===== -->
      <div class="view" id="viewSettings">
        <div id="settingsContent"></div>
      </div>
    </div>

    <!-- TAB BAR -->
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="viewWorkout">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6.5 6.5h11M6 12h12M6.5 17.5h11"/><circle cx="4" cy="6.5" r="1.5"/><circle cx="4" cy="12" r="1.5"/><circle cx="4" cy="17.5" r="1.5"/></svg>
        Workout
      </button>
      <button class="tab-btn" data-tab="viewHistory">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="9"/></svg>
        History
      </button>
      <button class="tab-btn" data-tab="viewProgress">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        Progress
      </button>
      <button class="tab-btn" data-tab="viewSettings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
        Settings
      </button>
    </div>
  </div>

  <!-- REST TIMER BANNER -->
  <div class="timer-overlay" id="timerOverlay">
    <div class="timer-display" id="timerDisplay">2:00</div>
    <div class="timer-btns">
      <button class="btn btn-primary btn-sm" onclick="App.addTime(30)">+30s</button>
      <button class="btn btn-outline btn-sm" onclick="App.stopTimer()">Skip</button>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" id="modalContent"></div>
  </div>

<script>
// ================================================================
//  531 WORKOUT TRACKER - Complete Application
// ================================================================

const App = (() => {
  'use strict';

  // ===== 5/3/1 SCHEME =====
  const SCHEME = {
    1: [{ pct: 0.65, reps: 5 }, { pct: 0.75, reps: 5 }, { pct: 0.85, reps: '5+' }],
    2: [{ pct: 0.70, reps: 3 }, { pct: 0.80, reps: 3 }, { pct: 0.90, reps: '3+' }],
    3: [{ pct: 0.75, reps: 5 }, { pct: 0.85, reps: 3 }, { pct: 0.95, reps: '1+' }],
    4: [{ pct: 0.40, reps: 5 }, { pct: 0.50, reps: 5 }, { pct: 0.60, reps: 5 }],
  };
  const WARMUP = [{ pct: 0.40, reps: 5 }, { pct: 0.50, reps: 5 }, { pct: 0.60, reps: 3 }];
  const PLATES = [45, 25, 10, 5, 2.5];
  const BAR_WEIGHT = 45;

  // ===== PROGRAM TEMPLATES =====
  const TEMPLATES = {
    currentSplit: {
      id: 'currentSplit',
      name: 'BBB Bodybuilding Split',
      description: 'Your 4-day bodypart split with 5/3/1 main lifts',
      daysPerWeek: 4,
      cycleWeeks: 3,
      days: [
        {
          name: 'Chest & Triceps', mainLift: 'bench', supplemental: null,
          accessories: [
            { name: 'Neutral-Grip DB Bench',     sets: 4, repsLow: 8,  repsHigh: 12, lastWeight: 0, lastReps: [] },
            { name: 'Landmine Incline Press',     sets: 3, repsLow: 10, repsHigh: 12, lastWeight: 0, lastReps: [] },
            { name: 'Cable / Pec-Deck Flyes',     sets: 4, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'OH DB / Cable Triceps Ext.', sets: 4, repsLow: 10, repsHigh: 12, lastWeight: 0, lastReps: [] },
            { name: 'Triceps Pushdowns',           sets: 3, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Legs & Abs', mainLift: 'frontSquat', supplemental: null,
          accessories: [
            { name: 'Step Ups',                 sets: 4, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Hip Thrusts',              sets: 3, repsLow: 10, repsHigh: 10, lastWeight: 0, lastReps: [] },
            { name: 'Leg Curls (Seated/Lying)', sets: 4, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Standing Calf Raises',     sets: 3, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Cable / Weighted Crunches',sets: 4, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Shoulders & Biceps', mainLift: 'ohp', supplemental: null,
          accessories: [
            { name: 'Landmine Press',              sets: 4, repsLow: 10, repsHigh: 12, lastWeight: 0, lastReps: [] },
            { name: 'DB Lateral Raises',            sets: 4, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Cable / DB Rear Delt Flyes',  sets: 3, repsLow: 15, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Behind-the-Body Cable Curls', sets: 4, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Hammer Curls',                  sets: 3, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Back', mainLift: 'rdl', supplemental: null,
          accessories: [
            { name: 'Chest-Supported Row',             sets: 4, repsLow: 8,  repsHigh: 12, lastWeight: 0, lastReps: [] },
            { name: 'Lat Pulldown / Neutral Pull-ups', sets: 4, repsLow: 10, repsHigh: 12, lastWeight: 0, lastReps: [] },
            { name: 'Rope Rows (per side)',             sets: 2, repsLow: 15, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'DB Shrugs (2s squeeze)',           sets: 4, repsLow: 10, repsHigh: 12, lastWeight: 0, lastReps: [] },
            { name: 'Abs',                               sets: 3, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
      ]
    },
    bbb: {
      id: 'bbb',
      name: 'Boring But Big',
      description: '5/3/1 + 5x10 supplemental at 50% TM for hypertrophy',
      daysPerWeek: 4,
      cycleWeeks: 3,
      days: [
        {
          name: 'OHP + Bench Volume', mainLift: 'ohp',
          supplemental: { type: 'bbb', liftKey: 'bench', sets: 5, reps: 10, pct: 0.50 },
          accessories: [
            { name: 'Chin-ups / Lat Pulldown', sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Face Pulls',               sets: 3, repsLow: 15, repsHigh: 20, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Squat + Deadlift Volume', mainLift: 'frontSquat',
          supplemental: { type: 'bbb', liftKey: 'rdl', sets: 5, reps: 10, pct: 0.50 },
          accessories: [
            { name: 'Leg Curls',    sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Ab Wheel',     sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Bench + OHP Volume', mainLift: 'bench',
          supplemental: { type: 'bbb', liftKey: 'ohp', sets: 5, reps: 10, pct: 0.50 },
          accessories: [
            { name: 'DB Rows',       sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Curls',         sets: 3, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Deadlift + Squat Volume', mainLift: 'rdl',
          supplemental: { type: 'bbb', liftKey: 'frontSquat', sets: 5, reps: 10, pct: 0.50 },
          accessories: [
            { name: 'Lunges',            sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Hanging Leg Raise', sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
      ]
    },
    fsl: {
      id: 'fsl',
      name: 'First Set Last',
      description: '5/3/1 + 5x5 at first working set % for strength + moderate volume',
      daysPerWeek: 4,
      cycleWeeks: 3,
      days: [
        {
          name: 'OHP', mainLift: 'ohp',
          supplemental: { type: 'fsl', liftKey: 'ohp', sets: 5, reps: 5, pct: 'fsl' },
          accessories: [
            { name: 'Chin-ups / Lat Pulldown', sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Dips / DB Bench',          sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Face Pulls',               sets: 5, repsLow: 15, repsHigh: 20, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Front Squat', mainLift: 'frontSquat',
          supplemental: { type: 'fsl', liftKey: 'frontSquat', sets: 5, reps: 5, pct: 'fsl' },
          accessories: [
            { name: 'Leg Curls',            sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Single-Leg Work',      sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Ab Wheel / Planks',    sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Bench Press', mainLift: 'bench',
          supplemental: { type: 'fsl', liftKey: 'bench', sets: 5, reps: 5, pct: 'fsl' },
          accessories: [
            { name: 'DB Rows',               sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'DB Flyes / Push-ups',   sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Curls',                  sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Romanian Deadlift', mainLift: 'rdl',
          supplemental: { type: 'fsl', liftKey: 'rdl', sets: 5, reps: 5, pct: 'fsl' },
          accessories: [
            { name: 'Good Mornings / Back Ext.',  sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Lunges',                      sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Hanging Leg Raise',            sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
      ]
    },
    bbs: {
      id: 'bbs',
      name: 'Boring But Strong',
      description: '5/3/1 + 10x5 at first working set % for high-volume strength',
      daysPerWeek: 4,
      cycleWeeks: 3,
      days: [
        {
          name: 'OHP', mainLift: 'ohp',
          supplemental: { type: 'bbs', liftKey: 'ohp', sets: 10, reps: 5, pct: 'fsl' },
          accessories: [
            { name: 'Chin-ups / Rows', sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Face Pulls',       sets: 3, repsLow: 15, repsHigh: 20, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Front Squat', mainLift: 'frontSquat',
          supplemental: { type: 'bbs', liftKey: 'frontSquat', sets: 10, reps: 5, pct: 'fsl' },
          accessories: [
            { name: 'Leg Curls',   sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Ab Work',     sets: 3, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Bench Press', mainLift: 'bench',
          supplemental: { type: 'bbs', liftKey: 'bench', sets: 10, reps: 5, pct: 'fsl' },
          accessories: [
            { name: 'DB Rows',  sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Curls',    sets: 3, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Romanian Deadlift', mainLift: 'rdl',
          supplemental: { type: 'bbs', liftKey: 'rdl', sets: 10, reps: 5, pct: 'fsl' },
          accessories: [
            { name: 'Lunges',              sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Hanging Leg Raise',   sets: 3, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
      ]
    },
    triumvirate: {
      id: 'triumvirate',
      name: 'Triumvirate',
      description: 'Minimalist: 5/3/1 + only 2 accessories per day (5x15 + 5x10)',
      daysPerWeek: 4,
      cycleWeeks: 3,
      days: [
        {
          name: 'OHP', mainLift: 'ohp', supplemental: null,
          accessories: [
            { name: 'Dips',         sets: 5, repsLow: 15, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Chin-ups',     sets: 5, repsLow: 10, repsHigh: 10, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Front Squat', mainLift: 'frontSquat', supplemental: null,
          accessories: [
            { name: 'Leg Press',    sets: 5, repsLow: 15, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Leg Curls',    sets: 5, repsLow: 10, repsHigh: 10, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Bench Press', mainLift: 'bench', supplemental: null,
          accessories: [
            { name: 'DB Flyes',     sets: 5, repsLow: 15, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'DB Rows',      sets: 5, repsLow: 10, repsHigh: 10, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Romanian Deadlift', mainLift: 'rdl', supplemental: null,
          accessories: [
            { name: 'Good Mornings',      sets: 5, repsLow: 15, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Hanging Leg Raise',  sets: 5, repsLow: 10, repsHigh: 10, lastWeight: 0, lastReps: [] },
          ]
        },
      ]
    },
    btm: {
      id: 'btm',
      name: 'Building the Monolith',
      description: '3-day high-volume challenge: widowmakers, 100-rep chin/dip sets (6-week program)',
      daysPerWeek: 3,
      cycleWeeks: 3,
      days: [
        {
          name: 'Squat + Press', mainLift: 'frontSquat',
          supplemental: { type: 'widowmaker', liftKey: 'frontSquat', sets: 1, reps: 20, pct: 0.50 },
          accessories: [
            { name: 'Chin-ups',     sets: 5, repsLow: 20, repsHigh: 20, lastWeight: 0, lastReps: [] },
            { name: 'Dips',         sets: 5, repsLow: 20, repsHigh: 20, lastWeight: 0, lastReps: [] },
            { name: 'Face Pulls',   sets: 5, repsLow: 20, repsHigh: 20, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Bench + Rows', mainLift: 'bench',
          supplemental: { type: 'bbb', liftKey: 'bench', sets: 5, reps: 5, pct: 0.85 },
          accessories: [
            { name: 'DB Rows',             sets: 5, repsLow: 10, repsHigh: 20, lastWeight: 0, lastReps: [] },
            { name: 'Curls',               sets: 4, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Triceps Pushdowns',   sets: 4, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Deadlift + Press', mainLift: 'rdl',
          supplemental: { type: 'widowmaker', liftKey: 'frontSquat', sets: 1, reps: 20, pct: 0.50 },
          accessories: [
            { name: 'Chin-ups',             sets: 5, repsLow: 20, repsHigh: 20, lastWeight: 0, lastReps: [] },
            { name: 'Shrugs',               sets: 5, repsLow: 20, repsHigh: 20, lastWeight: 0, lastReps: [] },
            { name: 'Face Pulls',            sets: 5, repsLow: 20, repsHigh: 20, lastWeight: 0, lastReps: [] },
          ]
        },
      ]
    },
    leviathan: {
      id: 'leviathan',
      name: 'Leviathan',
      description: '5/3/1 + work to TM single, then 5x5 FSL for heavy singles focus',
      daysPerWeek: 4,
      cycleWeeks: 3,
      days: [
        {
          name: 'OHP', mainLift: 'ohp',
          supplemental: { type: 'fsl', liftKey: 'ohp', sets: 5, reps: 5, pct: 'fsl', tmSingle: true },
          accessories: [
            { name: 'Chin-ups / Rows',  sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Face Pulls',        sets: 3, repsLow: 15, repsHigh: 20, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Front Squat', mainLift: 'frontSquat',
          supplemental: { type: 'fsl', liftKey: 'frontSquat', sets: 5, reps: 5, pct: 'fsl', tmSingle: true },
          accessories: [
            { name: 'Leg Curls',        sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Ab Work',          sets: 3, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Bench Press', mainLift: 'bench',
          supplemental: { type: 'fsl', liftKey: 'bench', sets: 5, reps: 5, pct: 'fsl', tmSingle: true },
          accessories: [
            { name: 'DB Rows',      sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Curls',        sets: 3, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Romanian Deadlift', mainLift: 'rdl',
          supplemental: { type: 'fsl', liftKey: 'rdl', sets: 5, reps: 5, pct: 'fsl', tmSingle: true },
          accessories: [
            { name: 'Lunges',              sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Hanging Leg Raise',   sets: 3, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
      ]
    },
    godIsABeast: {
      id: 'godIsABeast',
      name: 'God Is a Beast',
      description: 'Phased: BBS-style 10x5 in leader cycles, FSL 5x5 in anchor cycles',
      daysPerWeek: 4,
      cycleWeeks: 3,
      days: [
        {
          name: 'OHP', mainLift: 'ohp',
          supplemental: { type: 'bbs', liftKey: 'ohp', sets: 10, reps: 5, pct: 'fsl', phased: true },
          accessories: [
            { name: 'Chin-ups / Rows',  sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Face Pulls',        sets: 3, repsLow: 15, repsHigh: 20, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Front Squat', mainLift: 'frontSquat',
          supplemental: { type: 'bbs', liftKey: 'frontSquat', sets: 10, reps: 5, pct: 'fsl', phased: true },
          accessories: [
            { name: 'Leg Curls',   sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Ab Work',     sets: 3, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Bench Press', mainLift: 'bench',
          supplemental: { type: 'bbs', liftKey: 'bench', sets: 10, reps: 5, pct: 'fsl', phased: true },
          accessories: [
            { name: 'DB Rows',   sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Curls',     sets: 3, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
        {
          name: 'Romanian Deadlift', mainLift: 'rdl',
          supplemental: { type: 'bbs', liftKey: 'rdl', sets: 10, reps: 5, pct: 'fsl', phased: true },
          accessories: [
            { name: 'Lunges',              sets: 5, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
            { name: 'Hanging Leg Raise',   sets: 3, repsLow: 10, repsHigh: 15, lastWeight: 0, lastReps: [] },
          ]
        },
      ]
    },
  };

  // ===== DEFAULT DATA =====
  const DEFAULT_DATA = {
    version: 3,
    settings: { units: 'lbs', includeDeload: false, template: 'currentSplit' },
    lifts: {
      bench:      { name: 'Bench Press',       tm: 240, type: 'upper' },
      frontSquat: { name: 'Front Squat',       tm: 195, type: 'lower' },
      ohp:        { name: 'Overhead Press',     tm: 155, type: 'upper' },
      rdl:        { name: 'Romanian Deadlift', tm: 210, type: 'lower' },
    },
    currentCycle: 1,
    currentWeek: 1,
    selectedDay: 0,
    days: [
      {
        name: 'Chest & Triceps', mainLift: 'bench',
        accessories: [
          { name: 'Neutral-Grip DB Bench',         sets: 4, repsLow: 8,  repsHigh: 12, lastWeight: 0, lastReps: [] },
          { name: 'Landmine Incline Press',         sets: 3, repsLow: 10, repsHigh: 12, lastWeight: 0, lastReps: [] },
          { name: 'Cable / Pec-Deck Flyes',         sets: 4, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
          { name: 'OH DB / Cable Triceps Ext.',     sets: 4, repsLow: 10, repsHigh: 12, lastWeight: 0, lastReps: [] },
          { name: 'Triceps Pushdowns',               sets: 3, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
        ]
      },
      {
        name: 'Legs & Abs', mainLift: 'frontSquat',
        accessories: [
          { name: 'Step Ups',                sets: 4, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
          { name: 'Hip Thrusts',             sets: 3, repsLow: 10, repsHigh: 10, lastWeight: 0, lastReps: [] },
          { name: 'Leg Curls (Seated/Lying)',sets: 4, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
          { name: 'Standing Calf Raises',    sets: 3, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
          { name: 'Cable / Weighted Crunches',sets: 4, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
        ]
      },
      {
        name: 'Shoulders & Biceps', mainLift: 'ohp',
        accessories: [
          { name: 'Landmine Press',               sets: 4, repsLow: 10, repsHigh: 12, lastWeight: 0, lastReps: [] },
          { name: 'DB Lateral Raises',             sets: 4, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
          { name: 'Cable / DB Rear Delt Flyes',   sets: 3, repsLow: 15, repsHigh: 15, lastWeight: 0, lastReps: [] },
          { name: 'Behind-the-Body Cable Curls',  sets: 4, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
          { name: 'Hammer Curls',                   sets: 3, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
        ]
      },
      {
        name: 'Back', mainLift: 'rdl',
        accessories: [
          { name: 'Chest-Supported Row',            sets: 4, repsLow: 8,  repsHigh: 12, lastWeight: 0, lastReps: [] },
          { name: 'Lat Pulldown / Neutral Pull-ups',sets: 4, repsLow: 10, repsHigh: 12, lastWeight: 0, lastReps: [] },
          { name: 'Rope Rows (per side)',            sets: 2, repsLow: 15, repsHigh: 15, lastWeight: 0, lastReps: [] },
          { name: 'DB Shrugs (2s squeeze)',          sets: 4, repsLow: 10, repsHigh: 12, lastWeight: 0, lastReps: [] },
          { name: 'Abs',                              sets: 3, repsLow: 12, repsHigh: 15, lastWeight: 0, lastReps: [] },
        ]
      },
    ],
    log: [],
    tmHistory: [],
  };

  // ===== STATE =====
  let data = {};
  let timerInterval = null;
  let timerEndTime = 0;
  let timerHasVibrated = false;
  let notificationTimeout = null;
  let workoutInProgress = {};
  let progressMonths = 9; // default projection range: 3, 6, 9, or 12

  // ===== STORAGE =====
  function save() { localStorage.setItem('531tracker', JSON.stringify(data)); }
  function load() {
    const raw = localStorage.getItem('531tracker');
    if (raw) {
      data = JSON.parse(raw);
      if (!data.version || data.version < 2) {
        data = { ...DEFAULT_DATA, ...data, version: 2 };
      }
      if (data.version < 3) {
        if (!data.settings.template) data.settings.template = 'currentSplit';
        data.days.forEach(d => { if (!d.supplemental) d.supplemental = null; });
        data.version = 3;
      }
    } else {
      data = JSON.parse(JSON.stringify(DEFAULT_DATA));
      data.tmHistory.push({
        date: new Date().toISOString().slice(0, 10),
        bench: 240, frontSquat: 195, ohp: 155, rdl: 210, cycle: 1
      });
      save();
    }
  }

  // ===== CALCULATIONS =====
  function roundWeight(w) { return Math.round(w / 5) * 5; }

  function calcPlates(totalWeight) {
    if (totalWeight <= BAR_WEIGHT) return 'Bar only';
    let perSide = (totalWeight - BAR_WEIGHT) / 2;
    const plates = [];
    for (const p of PLATES) {
      while (perSide >= p) { plates.push(p); perSide -= p; }
    }
    if (plates.length === 0) return 'Bar only';
    return plates.join(' + ');
  }

  function getWorkingSets(tm, week) {
    return SCHEME[week].map(s => ({
      weight: roundWeight(tm * s.pct),
      reps: s.reps,
      pct: Math.round(s.pct * 100),
      isAmrap: typeof s.reps === 'string' && s.reps.includes('+'),
    }));
  }

  function getWarmupSets(tm) {
    return WARMUP.map(s => ({
      weight: roundWeight(tm * s.pct),
      reps: s.reps,
      pct: Math.round(s.pct * 100),
    }));
  }

  function getSupplementalSets(supplemental, week) {
    if (!supplemental) return [];
    const liftTM = data.lifts[supplemental.liftKey].tm;
    let pct, sets, reps, label;
    // For God Is a Beast phased: leader cycles (odd) use BBS, anchor cycles (even) use FSL
    let effectiveType = supplemental.type;
    if (supplemental.phased) {
      effectiveType = (data.currentCycle % 2 === 1) ? 'bbs' : 'fsl';
    }
    switch (effectiveType) {
      case 'bbb':
        pct = supplemental.pct;
        sets = supplemental.sets;
        reps = supplemental.reps;
        label = 'BBB';
        break;
      case 'fsl':
        pct = SCHEME[week][0].pct;
        sets = supplemental.sets;
        reps = supplemental.reps;
        label = 'FSL';
        break;
      case 'bbs':
        pct = SCHEME[week][0].pct;
        sets = supplemental.sets;
        reps = supplemental.reps;
        label = 'BBS';
        break;
      case 'widowmaker':
        pct = supplemental.pct;
        sets = 1;
        reps = 20;
        label = 'Widowmaker';
        break;
      default:
        return [];
    }
    const weight = roundWeight(liftTM * pct);
    const result = [];
    // TM single for Leviathan
    if (supplemental.tmSingle) {
      result.push({ weight: roundWeight(liftTM * 1.0), reps: 1, pct: 100, label: 'TM Single' });
    }
    for (let i = 0; i < sets; i++) {
      result.push({ weight, reps, pct: Math.round(pct * 100), label });
    }
    return result;
  }

  function estimate1RM(weight, reps) {
    if (reps <= 0) return 0;
    if (reps === 1) return weight;
    return Math.round(weight * (1 + reps / 30));
  }

  function project1RM(current1RM, liftType, months) {
    // Each cycle ~3 weeks, upper +5/cycle, lower +10/cycle
    // TM is ~90% of 1RM, so 1RM increase is slightly more
    const weeksPerCycle = data.settings.includeDeload ? 4 : 3;
    const cycles = Math.floor((months * 4.33) / weeksPerCycle);
    const tmIncrease = liftType === 'upper' ? 5 * cycles : 10 * cycles;
    // 1RM increase proportional: if TM goes up X, 1RM goes up X/0.9
    return Math.round(current1RM + tmIncrease / 0.9);
  }

  function getEstimated1RMs() {
    const results = {};
    for (const [key, lift] of Object.entries(data.lifts)) {
      // Find most recent AMRAP for this lift
      let best = { e1rm: Math.round(lift.tm / 0.9), weight: 0, reps: 0, date: null };
      for (let i = data.log.length - 1; i >= 0; i--) {
        const entry = data.log[i];
        if (entry.mainLift && entry.mainLift.liftKey === key && entry.mainLift.amrapReps > 0) {
          const amrapSet = entry.mainLift.sets.find(s => s.isAmrap);
          if (amrapSet) {
            const e1rm = estimate1RM(amrapSet.weight, entry.mainLift.amrapReps);
            if (e1rm > best.e1rm || !best.date) {
              best = { e1rm, weight: amrapSet.weight, reps: entry.mainLift.amrapReps, date: entry.date };
            }
          }
          if (!best.date) best.date = entry.date;
          break; // use most recent
        }
      }
      results[key] = { ...lift, ...best };
    }
    return results;
  }

  function getProgressionRate() {
    if (data.tmHistory.length < 2) return null;
    const first = data.tmHistory[0];
    const last = data.tmHistory[data.tmHistory.length - 1];
    const daysBetween = (new Date(last.date) - new Date(first.date)) / (1000 * 60 * 60 * 24);
    if (daysBetween < 7) return null;
    const monthsBetween = daysBetween / 30.44;
    const rates = {};
    for (const key of Object.keys(data.lifts)) {
      if (first[key] !== undefined && last[key] !== undefined) {
        rates[key] = (last[key] - first[key]) / monthsBetween;
      }
    }
    return { rates, months: monthsBetween };
  }

  // ===== TIMER =====
  function getTimerRemaining() {
    return Math.ceil((timerEndTime - Date.now()) / 1000);
  }

  function timerTick() {
    const remaining = getTimerRemaining();
    updateTimerDisplay(remaining);
    if (remaining <= 0 && !timerHasVibrated) {
      timerHasVibrated = true;
      persistTimer();
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
    }
  }

  function persistTimer() {
    localStorage.setItem('531timer', JSON.stringify({ endTime: timerEndTime, hasVibrated: timerHasVibrated }));
  }

  function clearPersistedTimer() {
    localStorage.removeItem('531timer');
  }

  function loadPersistedTimer() {
    try {
      const raw = localStorage.getItem('531timer');
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      if (!parsed.endTime) return null;
      return parsed;
    } catch { return null; }
  }

  function requestNotificationPermission() {
    if (!('Notification' in window)) return;
    if (Notification.permission === 'default') {
      Notification.requestPermission().catch(() => {});
    }
  }

  function scheduleNotification(seconds) {
    cancelNotification();
    if (!('Notification' in window) || Notification.permission !== 'granted') return;
    notificationTimeout = setTimeout(() => {
      try { new Notification('Rest Complete', { body: 'Time to get back to work!', icon: './icon-192.png' }); } catch {}
    }, seconds * 1000);
  }

  function cancelNotification() {
    if (notificationTimeout) { clearTimeout(notificationTimeout); notificationTimeout = null; }
  }

  function startTimer(seconds = 120) {
    timerEndTime = Date.now() + (seconds * 1000);
    timerHasVibrated = false;
    persistTimer();
    document.getElementById('timerOverlay').classList.add('show');
    document.body.classList.add('timer-active');
    updateTimerDisplay(seconds);
    clearInterval(timerInterval);
    timerInterval = setInterval(timerTick, 1000);
    requestNotificationPermission();
    scheduleNotification(seconds);
  }

  function stopTimer() {
    clearInterval(timerInterval);
    timerInterval = null;
    timerEndTime = 0;
    timerHasVibrated = false;
    clearPersistedTimer();
    cancelNotification();
    document.getElementById('timerOverlay').classList.remove('show');
    document.body.classList.remove('timer-active');
  }

  function addTime(sec) {
    timerEndTime += sec * 1000;
    const remaining = getTimerRemaining();
    if (remaining > 0 && timerHasVibrated) {
      timerHasVibrated = false;
      scheduleNotification(remaining);
    }
    persistTimer();
    updateTimerDisplay(remaining);
  }

  function updateTimerDisplay(remaining) {
    if (remaining === undefined) remaining = getTimerRemaining();
    const abs = Math.abs(remaining);
    const m = Math.floor(abs / 60);
    const s = abs % 60;
    const prefix = remaining < 0 ? '-' : '';
    document.getElementById('timerDisplay').textContent = `${prefix}${m}:${s.toString().padStart(2, '0')}`;
    document.getElementById('timerDisplay').style.color = remaining <= 0 ? '#f07070' : '#ebebef';
  }

  // ===== UI RENDERING =====
  function render() {
    renderCycleBadge();
    renderWeekSelector();
    renderDaySelector();
    renderWorkout();
  }

  function renderCycleBadge() {
    const tmpl = TEMPLATES[data.settings.template];
    const tmplLabel = (tmpl && data.settings.template !== 'currentSplit') ? tmpl.name.split(' ').map(w => w[0]).join('') : '';
    const prefix = tmplLabel ? tmplLabel + ' | ' : '';
    document.getElementById('cycleBadge').textContent = `${prefix}W${data.currentWeek} / C${data.currentCycle}`;
  }

  function renderWeekSelector() {
    const cont = document.getElementById('weekSelector');
    const weeks = data.settings.includeDeload ? [1,2,3,4] : [1,2,3];
    const labels = { 1: 'Week 1 (5s)', 2: 'Week 2 (3s)', 3: 'Week 3 (1s)', 4: 'Deload' };
    cont.innerHTML = weeks.map(w => `
      <button class="week-btn ${w === data.currentWeek ? 'active' : ''}"
              onclick="App.setWeek(${w})">${labels[w]}</button>
    `).join('');
  }

  function renderDaySelector() {
    const cont = document.getElementById('daySelector');
    cont.innerHTML = data.days.map((day, i) => `
      <button class="day-btn ${i === data.selectedDay ? 'active' : ''}"
              onclick="App.selectDay(${i})">
        <span class="day-num">Day ${i + 1}</span>
        ${day.name.split(' & ')[0]}
      </button>
    `).join('');
  }

  function renderWorkout() {
    const cont = document.getElementById('workoutContent');
    const day = data.days[data.selectedDay];
    const lift = data.lifts[day.mainLift];
    const warmup = getWarmupSets(lift.tm);
    const working = getWorkingSets(lift.tm, data.currentWeek);

    const suppSets = getSupplementalSets(day.supplemental, data.currentWeek);

    // Initialize workout tracking state if needed
    const wKey = `${data.currentCycle}-${data.currentWeek}-${data.selectedDay}`;
    if (!workoutInProgress[wKey]) {
      workoutInProgress[wKey] = {
        setsCompleted: new Array(warmup.length + working.length).fill(false),
        suppCompleted: new Array(suppSets.length).fill(false),
        amrapReps: '',
        accWeights: day.accessories.map(a => {
          const w = a.lastWeight || 0;
          return a.lastWeights ? [...a.lastWeights] : new Array(a.sets).fill(w);
        }),
        accReps: day.accessories.map(a => new Array(a.sets).fill(0)),
      };
    }
    const wp = workoutInProgress[wKey];
    // Ensure suppCompleted array matches current supplemental sets length
    if (!wp.suppCompleted || wp.suppCompleted.length !== suppSets.length) {
      wp.suppCompleted = new Array(suppSets.length).fill(false);
    }

    let html = '';

    // Main Lift Card
    html += `<div class="card">
      <div class="flex-between mb-8">
        <div>
          <div class="card-title">${data.currentWeek === 4 ? 'Deload' : 'Main Lift'}</div>
          <div style="font-size:18px;font-weight:700">${lift.name}</div>
        </div>
        <div style="text-align:right">
          <div class="text-xs text-muted">Training Max</div>
          <div style="font-size:18px;font-weight:700;color:var(--accent)">${lift.tm} ${data.settings.units}</div>
        </div>
      </div>`;

    // Warmup
    html += `<div class="sets-section">
      <div class="sets-label">Warmup</div>`;
    warmup.forEach((s, i) => {
      const done = wp.setsCompleted[i];
      html += `<div class="set-row">
        <div class="set-num">${i + 1}</div>
        <div class="set-weight">
          ${s.weight} ${data.settings.units}
        </div>
        <div class="set-reps">${s.pct}% x ${s.reps}</div>
        <button class="set-check ${done ? 'done' : ''}" onclick="App.toggleSet('${wKey}',${i})">
          ${done ? '&#10003;' : ''}
        </button>
      </div>`;
    });
    html += `</div>`;

    // Working Sets
    html += `<div class="sets-section" style="margin-top:16px">
      <div class="sets-label">Working Sets</div>`;
    working.forEach((s, i) => {
      const idx = warmup.length + i;
      const done = wp.setsCompleted[idx];
      html += `<div class="set-row">
        <div class="set-num">${i + 1}</div>
        <div class="set-weight">
          ${s.weight} ${data.settings.units}
        </div>
        <div class="set-reps ${s.isAmrap ? 'amrap' : ''}">${s.pct}% x ${s.reps}</div>
        ${s.isAmrap ? `<input type="text" inputmode="numeric" class="amrap-input"
          value="${wp.amrapReps}"
          onchange="App.setAmrap('${wKey}',this.value)"
          onfocus="this.select()">` : ''}
        <button class="set-check ${done ? 'done' : ''}" onclick="App.toggleSet('${wKey}',${idx})">
          ${done ? '&#10003;' : ''}
        </button>
      </div>`;
    });
    html += `</div></div>`;

    // AMRAP Estimate
    if (wp.amrapReps && parseInt(wp.amrapReps) > 0) {
      const amrapSet = working.find(s => s.isAmrap);
      if (amrapSet) {
        const e1rm = estimate1RM(amrapSet.weight, parseInt(wp.amrapReps));
        html += `<div class="card" style="border-color:var(--warning)">
          <div class="flex-between">
            <div>
              <div class="text-xs text-muted">Estimated 1RM from this set</div>
              <div style="font-size:22px;font-weight:700;color:var(--warning)">${e1rm} ${data.settings.units}</div>
            </div>
            <div style="text-align:right">
              <div class="text-xs text-muted">Based on</div>
              <div class="text-sm">${amrapSet.weight} x ${wp.amrapReps}</div>
            </div>
          </div>
        </div>`;
      }
    }

    // Supplemental
    if (suppSets.length > 0) {
      const suppLift = day.supplemental ? data.lifts[day.supplemental.liftKey] : lift;
      const suppLabel = suppSets[0].label || 'Supplemental';
      html += `<div class="card">
        <div class="flex-between mb-8">
          <div>
            <div class="card-title supplemental-label">Supplemental <span class="supp-badge">${suppLabel}</span></div>
            <div style="font-size:16px;font-weight:600">${suppLift.name}</div>
          </div>
        </div>
        <div class="sets-section">`;
      suppSets.forEach((s, i) => {
        const done = wp.suppCompleted[i];
        html += `<div class="set-row">
          <div class="set-num">${i + 1}</div>
          <div class="set-weight">
            ${s.weight} ${data.settings.units}
          </div>
          <div class="set-reps">${s.pct}% x ${s.reps}</div>
          <button class="set-check ${done ? 'done' : ''}" onclick="App.toggleSupp('${wKey}',${i})">
            ${done ? '&#10003;' : ''}
          </button>
        </div>`;
      });
      html += `</div></div>`;
    }

    // Accessories
    html += `<div class="card">
      <div class="card-title">Accessories</div>`;
    day.accessories.forEach((acc, ai) => {
      const repsLabel = acc.repsLow === acc.repsHigh ? acc.repsLow : `${acc.repsLow}-${acc.repsHigh}`;
      const suggestion = getAccSuggestion(acc);
      // Ensure per-set weight array exists and matches set count
      if (!Array.isArray(wp.accWeights[ai]) || wp.accWeights[ai].length !== acc.sets) {
        const base = Array.isArray(wp.accWeights[ai]) ? wp.accWeights[ai] : [];
        const fallback = base[0] || acc.lastWeight || 0;
        wp.accWeights[ai] = new Array(acc.sets).fill(0).map((_, si) => base[si] !== undefined ? base[si] : fallback);
      }
      html += `<div class="acc-item">
        <div class="acc-header">
          <div>
            <div class="acc-name">${acc.name}</div>
            ${acc.lastWeights ? `<div class="acc-last">Last: ${[...new Set(acc.lastWeights)].map(w => w + ' lbs').join(' / ')}</div>` : (acc.lastWeight > 0 ? `<div class="acc-last">Last: ${acc.lastWeight} lbs</div>` : '')}
          </div>
          <div class="acc-target">${acc.sets} x ${repsLabel}</div>
        </div>
        <div class="acc-set-table">
          <div class="acc-set-row" style="padding-bottom:0">
            <div class="acc-set-label"></div>
            <div class="acc-input" style="border:none;background:none;color:var(--muted);font-size:11px;font-weight:700;height:auto">Weight</div>
            <div class="acc-set-x"></div>
            <div class="acc-input rp" style="border:none;background:none;color:var(--muted);font-size:11px;font-weight:700;height:auto">Reps</div>
          </div>`;
      for (let si = 0; si < acc.sets; si++) {
        const w = wp.accWeights[ai][si] || 0;
        const r = wp.accReps[ai][si] || 0;
        const filled = (w > 0 || r > 0) ? 'filled' : '';
        html += `<div class="acc-set-row">
            <div class="acc-set-label">S${si + 1}</div>
            <input type="text" inputmode="decimal" class="acc-input wt ${filled}"
                   value="${w || ''}"
                   onchange="App.setAccWeight('${wKey}',${ai},${si},this.value)" onfocus="this.select()">
            <div class="acc-set-x">x</div>
            <input type="text" inputmode="numeric" class="acc-input rp ${r > 0 ? 'filled' : ''}"
                   value="${r || ''}"
                   onchange="App.setAccRep('${wKey}',${ai},${si},this.value)" onfocus="this.select()">
          </div>`;
      }
      html += `</div>`;
      html += `<button class="acc-timer-btn" onclick="App.startTimer(90)">Rest 90s</button>`;
      if (suggestion) {
        html += `<div class="acc-suggestion">${suggestion}</div>`;
      }
      html += `</div>`;
    });
    html += `</div>`;

    // Log Workout Button
    html += `<button class="btn btn-success" onclick="App.logWorkout('${wKey}')" style="margin-top:8px">
      Log Workout
    </button>`;

    // Rest Timer button
    html += `<div class="inline-btns" style="margin-top:8px">
      <button class="btn btn-outline btn-sm" onclick="App.startTimer(90)">Rest 1:30</button>
      <button class="btn btn-outline btn-sm" onclick="App.startTimer(120)">Rest 2:00</button>
      <button class="btn btn-outline btn-sm" onclick="App.startTimer(180)">Rest 3:00</button>
    </div>`;

    // Quick Log fallback link
    html += `<div class="quick-log-link" onclick="App.showQuickLog()">Forgot to log a workout?</div>`;

    cont.innerHTML = html;
  }

  function getAccSuggestion(acc) {
    if (!acc.lastReps || acc.lastReps.length === 0) return null;
    const hasWeights = (acc.lastWeights && acc.lastWeights.some(w => w > 0)) || acc.lastWeight > 0;
    if (!hasWeights) return null;
    const allAtTop = acc.lastReps.every(r => r >= acc.repsHigh);
    if (allAtTop) {
      return `Hit all top-range reps last time. Consider adding 5 lbs.`;
    }
    return null;
  }

  function renderHistory() {
    const cont = document.getElementById('historyContent');
    if (data.log.length === 0) {
      cont.innerHTML = `<div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="9"/></svg>
        <p>No workouts logged yet.<br>Complete a workout to see your history.</p>
      </div>`;
      return;
    }

    let html = '<div class="card-title">Workout History</div>';
    const sorted = [...data.log].reverse();
    sorted.forEach((entry, idx) => {
      const day = (entry.template && TEMPLATES[entry.template] && TEMPLATES[entry.template].days[entry.dayIndex])
        ? TEMPLATES[entry.template].days[entry.dayIndex]
        : (data.days[entry.dayIndex] || { name: 'Unknown' });
      const topSet = entry.mainLift ? entry.mainLift.sets[entry.mainLift.sets.length - 1] : null;
      const amrap = entry.mainLift ? entry.mainLift.amrapReps : 0;
      const liftName = entry.mainLift ? (data.lifts[entry.mainLift.liftKey] || {}).name || '' : '';
      const e1rm = topSet && amrap > 0 ? estimate1RM(topSet.weight, amrap) : null;

      html += `<div class="card history-item" onclick="App.toggleHistory(${idx})">
        <div class="history-header">
          <div>
            <div class="history-date">${formatDate(entry.date)}</div>
            <div class="history-day">${day.name}</div>
            ${topSet ? `<div class="history-lift">${liftName}: ${topSet.weight} x ${amrap || topSet.reps}${e1rm ? ` (e1RM: ${e1rm})` : ''}</div>` : ''}
          </div>
          ${entry.quickLog ? '<span class="ql-badge">Quick Log</span>' : ''}
          <div class="cycle-badge" style="font-size:11px">W${entry.week}/C${entry.cycle}</div>
        </div>
        <div class="history-detail" id="histDetail_${idx}">
          ${renderHistoryDetail(entry)}
        </div>
      </div>`;
    });
    cont.innerHTML = html;
  }

  function renderHistoryDetail(entry) {
    let html = '';
    if (entry.template && entry.template !== 'currentSplit') {
      const tmpl = TEMPLATES[entry.template];
      html += `<div class="text-xs text-muted mb-8">Template: ${tmpl ? tmpl.name : entry.template}</div>`;
    }
    if (entry.mainLift) {
      html += '<div class="mb-8"><strong>Main Lift Sets:</strong></div>';
      entry.mainLift.sets.forEach((s, i) => {
        html += `<div class="text-sm" style="margin-left:8px">${i + 1}. ${s.weight} x ${s.isAmrap ? entry.mainLift.amrapReps || s.reps : s.reps}</div>`;
      });
    }
    if (entry.supplemental && entry.supplemental.sets && entry.supplemental.sets.length > 0) {
      const suppLiftName = data.lifts[entry.supplemental.liftKey] ? data.lifts[entry.supplemental.liftKey].name : entry.supplemental.liftKey;
      html += `<div class="mt-8 mb-8"><strong>Supplemental (${entry.supplemental.type.toUpperCase()}) - ${suppLiftName}:</strong></div>`;
      entry.supplemental.sets.forEach((s, i) => {
        html += `<div class="text-sm" style="margin-left:8px">${i + 1}. ${s.weight} x ${s.reps}</div>`;
      });
    }
    if (entry.accessories && entry.accessories.length > 0) {
      html += '<div class="mt-8 mb-8"><strong>Accessories:</strong></div>';
      entry.accessories.forEach(a => {
        const hasData = (a.weights && a.weights.some(w => w > 0)) || a.weight > 0 || (a.reps && a.reps.some(r => r > 0));
        if (hasData) {
          if (a.weights && a.weights.length > 0) {
            const setStrs = a.weights.map((w, i) => {
              const r = a.reps && a.reps[i] ? a.reps[i] : '?';
              return `${w}x${r}`;
            }).filter((_, i) => (a.weights[i] > 0 || (a.reps && a.reps[i] > 0)));
            html += `<div class="text-sm" style="margin-left:8px">${a.name}: ${setStrs.join(', ')}</div>`;
          } else {
            html += `<div class="text-sm" style="margin-left:8px">${a.name}: ${a.weight || 0} lbs - ${a.reps.join(', ')} reps</div>`;
          }
        }
      });
    }
    return html;
  }

  // ===== CHART DRAWING =====
  const LIFT_COLORS = {
    bench: '#5b9aff',
    frontSquat: '#5cd6a0',
    ohp: '#f0c050',
    rdl: '#f07070',
  };

  function drawProjectionChart(canvasId) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    const W = rect.width;
    const H = rect.height;

    const e1rms = getEstimated1RMs();
    const liftKeys = Object.keys(data.lifts);

    // Build data: past TM history points + future projections
    const now = new Date();
    const projMonths = progressMonths;
    const timePoints = [0];
    for (let m = 3; m <= projMonths; m += 3) timePoints.push(m);

    // Collect all TM history dates as months-from-now (negative = past)
    const historyMonths = data.tmHistory.map(h => {
      const d = new Date(h.date + 'T12:00:00');
      return (d - now) / (1000 * 60 * 60 * 24 * 30.44);
    });

    // Build series per lift: history e1rm points + projection points
    const series = {};
    let allValues = [];
    let allMonths = [];

    for (const key of liftKeys) {
      const points = [];
      // Historical points from TM history (convert TM to e1rm)
      data.tmHistory.forEach((h, i) => {
        if (h[key] !== undefined) {
          const e1rm = Math.round(h[key] / 0.9);
          points.push({ month: historyMonths[i], value: e1rm, type: 'history' });
          allValues.push(e1rm);
          allMonths.push(historyMonths[i]);
        }
      });
      // Current estimated 1RM
      const currentE1rm = e1rms[key].e1rm;
      points.push({ month: 0, value: currentE1rm, type: 'current' });
      allValues.push(currentE1rm);
      allMonths.push(0);
      // Future projections
      for (const m of timePoints.slice(1)) {
        const proj = project1RM(currentE1rm, data.lifts[key].type, m);
        points.push({ month: m, value: proj, type: 'projection' });
        allValues.push(proj);
        allMonths.push(m);
      }
      // Sort by month
      points.sort((a, b) => a.month - b.month);
      series[key] = points;
    }

    // Calculate chart bounds
    const padding = { top: 24, right: 16, bottom: 36, left: 44 };
    const chartW = W - padding.left - padding.right;
    const chartH = H - padding.top - padding.bottom;
    const minMonth = Math.min(...allMonths, -1);
    const maxMonth = Math.max(...allMonths, projMonths);
    const minVal = Math.min(...allValues) - 15;
    const maxVal = Math.max(...allValues) + 15;

    function xPos(month) { return padding.left + ((month - minMonth) / (maxMonth - minMonth)) * chartW; }
    function yPos(val) { return padding.top + (1 - (val - minVal) / (maxVal - minVal)) * chartH; }

    // Background
    ctx.fillStyle = '#18181b';
    ctx.fillRect(0, 0, W, H);

    // Grid lines (horizontal)
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = 1;
    const gridSteps = 5;
    const valStep = Math.ceil((maxVal - minVal) / gridSteps / 10) * 10;
    const gridStart = Math.floor(minVal / valStep) * valStep;
    ctx.font = '11px -apple-system, system-ui, sans-serif';
    ctx.fillStyle = '#6e6e80';
    ctx.textAlign = 'right';
    for (let v = gridStart; v <= maxVal; v += valStep) {
      const y = yPos(v);
      if (y >= padding.top && y <= H - padding.bottom) {
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(W - padding.right, y);
        ctx.stroke();
        ctx.fillText(v.toString(), padding.left - 6, y + 4);
      }
    }

    // "Now" vertical line
    const nowX = xPos(0);
    ctx.strokeStyle = 'rgba(255,255,255,0.12)';
    ctx.setLineDash([4, 4]);
    ctx.beginPath();
    ctx.moveTo(nowX, padding.top);
    ctx.lineTo(nowX, H - padding.bottom);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#6e6e80';
    ctx.textAlign = 'center';
    ctx.fillText('Now', nowX, H - padding.bottom + 14);

    // Month labels on X-axis
    for (const m of timePoints.slice(1)) {
      ctx.fillStyle = '#6e6e80';
      ctx.fillText(`+${m}mo`, xPos(m), H - padding.bottom + 14);
    }
    // Past labels
    if (historyMonths.length > 1) {
      const earliest = Math.min(...historyMonths);
      if (earliest < -0.5) {
        ctx.fillText(`${Math.round(earliest)}mo`, xPos(earliest), H - padding.bottom + 14);
      }
    }

    // Y-axis label
    ctx.save();
    ctx.fillStyle = '#6e6e80';
    ctx.font = '10px -apple-system, system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.translate(12, H / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText('Est. 1RM (lbs)', 0, 0);
    ctx.restore();

    // Draw lift lines
    for (const key of liftKeys) {
      const pts = series[key];
      const color = LIFT_COLORS[key] || '#fff';

      // Split into history/current (solid) and projection (dashed)
      const solidPts = pts.filter(p => p.month <= 0);
      const projPts = pts.filter(p => p.month >= 0);

      // Solid line (history to now)
      if (solidPts.length >= 2) {
        ctx.strokeStyle = color;
        ctx.lineWidth = 2.5;
        ctx.setLineDash([]);
        ctx.beginPath();
        solidPts.forEach((p, i) => {
          const x = xPos(p.month), y = yPos(p.value);
          i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        });
        ctx.stroke();
      }

      // Dashed line (now to future)
      if (projPts.length >= 2) {
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.setLineDash([6, 4]);
        ctx.beginPath();
        projPts.forEach((p, i) => {
          const x = xPos(p.month), y = yPos(p.value);
          i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        });
        ctx.stroke();
        ctx.setLineDash([]);
      }

      // Dots
      pts.forEach(p => {
        const x = xPos(p.month), y = yPos(p.value);
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x, y, p.type === 'current' ? 5 : 3.5, 0, Math.PI * 2);
        ctx.fill();
        // White ring on current
        if (p.type === 'current') {
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(x, y, 5, 0, Math.PI * 2);
          ctx.stroke();
        }
      });

      // Value label at 9-month projection
      const last = projPts[projPts.length - 1];
      if (last) {
        ctx.fillStyle = color;
        ctx.font = 'bold 11px -apple-system, system-ui, sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(last.value.toString(), xPos(last.month) + 6, yPos(last.value) + 4);
      }
    }
  }

  function renderProgress() {
    const cont = document.getElementById('progressContent');
    const e1rms = getEstimated1RMs();
    let html = '';

    // Time range toggle
    html += '<div class="time-toggle">';
    for (const m of [3, 6, 9, 12]) {
      html += `<button class="time-toggle-btn ${progressMonths === m ? 'active' : ''}" onclick="App.setProgressRange(${m})">${m} mo</button>`;
    }
    html += '</div>';

    // Current 1RM Estimates
    html += '<div class="card-title">Estimated 1 Rep Maxes</div>';
    html += '<div class="stat-grid">';
    for (const [key, info] of Object.entries(e1rms)) {
      html += `<div class="card stat-card">
        <div class="stat-value">${info.e1rm}</div>
        <div class="stat-label">${info.name}</div>
        ${info.date ? `<div class="text-xs text-muted mt-8">${info.weight} x ${info.reps}</div>` : `<div class="text-xs text-muted mt-8">From TM</div>`}
      </div>`;
    }
    html += '</div>';

    // Projection Chart
    html += '<div class="card"><div class="card-title">1RM Projection Graph</div>';
    html += '<div class="chart-container"><canvas id="projectionChart" style="width:100%;height:280px"></canvas></div>';
    html += '<div class="chart-legend">';
    for (const [key, lift] of Object.entries(data.lifts)) {
      html += `<div class="chart-legend-item">
        <div class="chart-legend-dot" style="background:${LIFT_COLORS[key]}"></div>
        ${lift.name}
      </div>`;
    }
    html += '</div>';
    html += '<div class="text-xs text-muted mt-8" style="text-align:center">Solid = history, Dashed = projected</div>';
    html += '</div>';

    // Current TMs
    html += '<div class="card"><div class="card-title">Current Training Maxes</div>';
    for (const [key, lift] of Object.entries(data.lifts)) {
      html += `<div class="flex-between" style="padding:6px 0;border-bottom:1px solid var(--card-border)">
        <span>${lift.name}</span>
        <span class="fw-700 text-accent">${lift.tm} ${data.settings.units}</span>
      </div>`;
    }
    html += '</div>';

    // Projections Table
    const projSteps = [];
    for (let m = 3; m <= progressMonths; m += 3) projSteps.push(m);
    html += '<div class="card"><div class="card-title">1RM Projections</div>';
    html += '<table class="projection-table"><thead><tr>';
    html += '<th>Lift</th><th>Now</th>';
    for (const m of projSteps) html += `<th>${m} mo</th>`;
    html += '</tr></thead><tbody>';
    for (const [key, info] of Object.entries(e1rms)) {
      html += `<tr><td class="fw-700">${info.name}</td><td>${info.e1rm}</td>`;
      for (const m of projSteps) {
        html += `<td class="trend-up">${project1RM(info.e1rm, info.type, m)}</td>`;
      }
      html += '</tr>';
    }
    html += '</tbody></table>';
    html += '<div class="text-xs text-muted mt-8">Based on standard 5/3/1 progression: +5 lbs/cycle (upper), +5-10 lbs/cycle (lower)</div>';
    html += '</div>';

    // Actual Progression Rate (if enough data)
    const rates = getProgressionRate();
    if (rates) {
      html += '<div class="card"><div class="card-title">Actual Progression Rate</div>';
      html += `<div class="text-xs text-muted mb-8">Over ${rates.months.toFixed(1)} months of training</div>`;
      for (const [key, rate] of Object.entries(rates.rates)) {
        const lift = data.lifts[key];
        if (lift) {
          html += `<div class="flex-between" style="padding:6px 0;border-bottom:1px solid var(--card-border)">
            <span>${lift.name}</span>
            <span class="${rate >= 0 ? 'trend-up' : ''} fw-700">${rate >= 0 ? '+' : ''}${rate.toFixed(1)} lbs/mo</span>
          </div>`;
        }
      }

      // Data-driven projections
      html += '<div class="mt-12"><div class="sets-label">Data-Driven 1RM Projections</div></div>';
      html += '<table class="projection-table"><thead><tr>';
      html += '<th>Lift</th><th>Now</th>';
      for (const m of projSteps) html += `<th>${m} mo</th>`;
      html += '</tr></thead><tbody>';
      for (const [key, info] of Object.entries(e1rms)) {
        const rate = rates.rates[key] || 0;
        const monthlyE1rmRate = rate / 0.9; // approximate
        html += `<tr><td class="fw-700">${info.name}</td><td>${info.e1rm}</td>`;
        for (const m of projSteps) {
          html += `<td class="trend-up">${Math.round(info.e1rm + monthlyE1rmRate * m)}</td>`;
        }
        html += '</tr>';
      }
      html += '</tbody></table>';
      html += '<div class="text-xs text-muted mt-8">Based on your actual TM progression history</div>';
      html += '</div>';
    }

    // TM History
    if (data.tmHistory.length > 0) {
      html += '<div class="card"><div class="card-title">TM History</div>';
      data.tmHistory.slice().reverse().forEach(h => {
        html += `<div style="padding:6px 0;border-bottom:1px solid var(--card-border);font-size:13px">
          <div class="flex-between">
            <span class="text-muted">${formatDate(h.date)}${h.cycle ? ` (Cycle ${h.cycle})` : ''}</span>
          </div>
          <div style="display:flex;gap:12px;margin-top:4px">`;
        for (const [key, lift] of Object.entries(data.lifts)) {
          if (h[key] !== undefined) {
            html += `<span><span class="text-muted">${lift.name.slice(0,2)}:</span> ${h[key]}</span>`;
          }
        }
        html += '</div></div>';
      });
      html += '</div>';
    }

    cont.innerHTML = html;

    // Draw the chart after DOM update
    requestAnimationFrame(() => drawProjectionChart('projectionChart'));
  }

  function renderSettings() {
    const cont = document.getElementById('settingsContent');
    let html = '';

    // Program Template
    const currentTmpl = TEMPLATES[data.settings.template] || TEMPLATES.currentSplit;
    html += `<div class="card">
      <div class="card-title">Program Template</div>
      <div class="template-current">${currentTmpl.name}</div>
      <div class="text-xs text-muted mb-8">${currentTmpl.description}</div>
      <div class="text-xs text-muted mb-8">${currentTmpl.daysPerWeek} days/week</div>
      <button class="btn btn-outline btn-sm" onclick="App.openTemplateSelector()">Change Template</button>
    </div>`;

    // Training Maxes
    html += '<div class="card"><div class="card-title">Training Maxes</div>';
    for (const [key, lift] of Object.entries(data.lifts)) {
      html += `<div class="setting-row">
        <label>${lift.name}</label>
        <input type="number" value="${lift.tm}" min="0" step="5"
               onchange="App.updateTM('${key}', this.value)" onfocus="this.select()">
        <span class="text-muted text-sm">${data.settings.units}</span>
      </div>`;
    }
    html += '</div>';

    // Cycle & Week
    html += `<div class="card"><div class="card-title">Cycle & Week</div>
      <div class="setting-row">
        <label>Current Cycle</label>
        <input type="number" value="${data.currentCycle}" min="1"
               onchange="App.setCycle(this.value)" onfocus="this.select()">
      </div>
      <div class="setting-row">
        <label>Current Week</label>
        <select onchange="App.setWeek(parseInt(this.value))">
          <option value="1" ${data.currentWeek===1?'selected':''}>Week 1 (5s)</option>
          <option value="2" ${data.currentWeek===2?'selected':''}>Week 2 (3s)</option>
          <option value="3" ${data.currentWeek===3?'selected':''}>Week 3 (1s)</option>
          <option value="4" ${data.currentWeek===4?'selected':''}>Deload</option>
        </select>
      </div>
      <div class="setting-row">
        <label>Include Deload Week</label>
        <select onchange="App.toggleDeload(this.value)">
          <option value="false" ${!data.settings.includeDeload?'selected':''}>No (3-week cycles)</option>
          <option value="true" ${data.settings.includeDeload?'selected':''}>Yes (4-week cycles)</option>
        </select>
      </div>
    </div>`;

    // Advance Cycle
    html += `<div class="card"><div class="card-title">Cycle Management</div>
      <p class="text-sm text-muted mb-8">Advance to the next cycle. Choose how much to increase each training max.</p>
      <button class="btn btn-primary" onclick="App.advanceCycle()">Advance to Next Cycle</button>
    </div>`;

    // Accessory Management
    html += '<div class="card"><div class="card-title">Accessories</div>';
    data.days.forEach((day, di) => {
      html += `<div style="margin-bottom:16px">
        <div class="fw-700 mb-8">${day.name}</div>`;
      day.accessories.forEach((acc, ai) => {
        const reps = acc.repsLow === acc.repsHigh ? acc.repsLow : `${acc.repsLow}-${acc.repsHigh}`;
        html += `<div class="flex-between text-sm" style="padding:4px 0">
          <span>${acc.name}</span>
          <span class="text-muted">${acc.sets}x${reps}</span>
        </div>`;
      });
      html += `<button class="btn btn-outline btn-sm mt-8" onclick="App.editAccessories(${di})">Edit Day ${di+1}</button>`;
      html += '</div>';
    });
    html += '</div>';

    // Data Management
    html += `<div class="card"><div class="card-title">Data</div>
      <div class="inline-btns">
        <button class="btn btn-outline btn-sm" onclick="App.exportData()">Export JSON</button>
        <button class="btn btn-outline btn-sm" onclick="document.getElementById('importFile').click()">Import JSON</button>
      </div>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="App.importData(this)">
      <button class="btn btn-danger btn-sm" style="margin-top:10px" onclick="App.resetData()">Reset All Data</button>
    </div>`;

    cont.innerHTML = html;
  }

  // ===== ACTIONS =====
  function selectDay(i) {
    data.selectedDay = i;
    save();
    renderDaySelector();
    renderWorkout();
  }

  function setWeek(w) {
    data.currentWeek = parseInt(w);
    save();
    render();
  }

  function setCycle(c) {
    data.currentCycle = parseInt(c);
    save();
    renderCycleBadge();
  }

  function toggleSet(wKey, idx) {
    if (!workoutInProgress[wKey]) return;
    workoutInProgress[wKey].setsCompleted[idx] = !workoutInProgress[wKey].setsCompleted[idx];
    renderWorkout();
    if (workoutInProgress[wKey].setsCompleted[idx]) {
      startTimer(120);
    }
  }

  function toggleSupp(wKey, idx) {
    if (!workoutInProgress[wKey]) return;
    if (!workoutInProgress[wKey].suppCompleted) return;
    workoutInProgress[wKey].suppCompleted[idx] = !workoutInProgress[wKey].suppCompleted[idx];
    renderWorkout();
    if (workoutInProgress[wKey].suppCompleted[idx]) {
      startTimer(120);
    }
  }

  function setAmrap(wKey, val) {
    if (!workoutInProgress[wKey]) return;
    workoutInProgress[wKey].amrapReps = val;
    renderWorkout();
  }

  function setAccWeight(wKey, accIdx, setIdx, val) {
    if (!workoutInProgress[wKey]) return;
    const wp = workoutInProgress[wKey];
    if (!Array.isArray(wp.accWeights[accIdx])) wp.accWeights[accIdx] = [];
    wp.accWeights[accIdx][setIdx] = parseFloat(val) || 0;
  }

  function setAccRep(wKey, accIdx, setIdx, val) {
    if (!workoutInProgress[wKey]) return;
    workoutInProgress[wKey].accReps[accIdx][setIdx] = parseInt(val) || 0;
  }

  function logWorkout(wKey) {
    const wp = workoutInProgress[wKey];
    if (!wp) return;

    const day = data.days[data.selectedDay];
    const lift = data.lifts[day.mainLift];
    const working = getWorkingSets(lift.tm, data.currentWeek);

    const suppSetsLog = getSupplementalSets(day.supplemental, data.currentWeek);

    const entry = {
      id: Date.now().toString(36),
      date: new Date().toISOString().slice(0, 10),
      dayIndex: data.selectedDay,
      cycle: data.currentCycle,
      week: data.currentWeek,
      template: data.settings.template,
      mainLift: {
        liftKey: day.mainLift,
        tm: lift.tm,
        amrapReps: parseInt(wp.amrapReps) || 0,
        sets: working.map(s => ({
          weight: s.weight, reps: s.reps, pct: s.pct, isAmrap: s.isAmrap,
        })),
      },
      supplemental: suppSetsLog.length > 0 ? {
        type: day.supplemental.type,
        liftKey: day.supplemental.liftKey,
        sets: suppSetsLog.map(s => ({ weight: s.weight, reps: s.reps })),
      } : null,
      accessories: day.accessories.map((acc, ai) => ({
        name: acc.name,
        weights: Array.isArray(wp.accWeights[ai]) ? [...wp.accWeights[ai]] : [],
        reps: wp.accReps[ai] || [],
      })),
    };

    data.log.push(entry);

    // Update last weights/reps on accessories for next time suggestions
    day.accessories.forEach((acc, ai) => {
      const ws = Array.isArray(wp.accWeights[ai]) ? wp.accWeights[ai] : [];
      const r = wp.accReps[ai];
      if (ws.some(w => w > 0)) {
        acc.lastWeights = [...ws];
        acc.lastWeight = ws[0] || 0;
      }
      if (r && r.some(x => x > 0)) acc.lastReps = [...r];
    });

    delete workoutInProgress[wKey];
    save();

    showModal(`<h3>Workout Logged!</h3>
      <p class="text-sm text-muted">${day.name} - Week ${data.currentWeek}, Cycle ${data.currentCycle}</p>
      ${entry.mainLift.amrapReps > 0 ? `<p class="mt-8">AMRAP: ${working[working.length-1].weight} x ${entry.mainLift.amrapReps}<br>
      <span class="text-warning fw-700">Estimated 1RM: ${estimate1RM(working[working.length-1].weight, entry.mainLift.amrapReps)} lbs</span></p>` : ''}
      <button class="btn btn-primary" onclick="App.closeModal()">OK</button>`);

    renderWorkout();
  }

  // ===== QUICK LOG (FALLBACK) =====
  let qlState = { dayIndex: 0, week: 1 };

  function showQuickLog() {
    qlState = { dayIndex: data.selectedDay, week: data.currentWeek };
    const today = new Date().toISOString().slice(0, 10);
    const weeks = data.settings.includeDeload ? [1,2,3,4] : [1,2,3];
    const weekLabels = { 1: 'W1 (5s)', 2: 'W2 (3s)', 3: 'W3 (1s)', 4: 'Deload' };

    let html = `<h3>Quick Log</h3>
      <p class="text-xs text-muted mb-16">Log just the main lift from a past workout.</p>
      <div class="ql-field">
        <label>Date</label>
        <input type="date" id="qlDate" value="${today}" max="${today}"
               style="background:var(--input-bg);border:1px solid var(--card-border);color:var(--text);border-radius:8px;padding:10px 12px;font-size:15px;width:100%">
      </div>
      <div class="ql-field">
        <label>Week</label>
        <div class="ql-week-grid">
          ${weeks.map(w => `<button class="ql-week-btn ${w === qlState.week ? 'active' : ''}"
            data-week="${w}" onclick="App.qlSetWeek(${w})">${weekLabels[w]}</button>`).join('')}
        </div>
      </div>
      <div class="ql-field">
        <label>Day</label>
        <div class="ql-day-grid">
          ${data.days.map((d, i) => `<button class="ql-day-btn ${i === qlState.dayIndex ? 'active' : ''}"
            onclick="App.qlSetDay(${i})">${d.name.split(' & ')[0]}</button>`).join('')}
        </div>
      </div>
      <div id="qlPreview"></div>
      <div class="ql-field" id="qlAmrapField" style="${qlState.week === 4 ? 'display:none' : ''}">
        <label>AMRAP Reps (top set)</label>
        <input type="text" inputmode="numeric" id="qlAmrap" placeholder="e.g. 8"
               style="text-align:center;font-size:18px;font-weight:700;border:2px solid var(--warning);color:var(--warning)"
               oninput="App.updateQuickLogPreview()">
      </div>
      <div id="qlDeloadNote" class="text-xs text-muted" style="margin-bottom:12px;${qlState.week === 4 ? '' : 'display:none'}">
        Deload week  no AMRAP set.
      </div>
      <div class="inline-btns">
        <button class="btn btn-outline" onclick="App.closeModal()">Cancel</button>
        <button class="btn btn-success" onclick="App.submitQuickLog()">Log Workout</button>
      </div>`;
    showModal(html);
    updateQuickLogPreview();
  }

  function qlSetDay(idx) {
    qlState.dayIndex = idx;
    document.querySelectorAll('.ql-day-btn').forEach((btn, i) => {
      btn.classList.toggle('active', i === idx);
    });
    updateQuickLogPreview();
  }

  function qlSetWeek(w) {
    qlState.week = w;
    document.querySelectorAll('.ql-week-btn').forEach(btn => {
      btn.classList.toggle('active', parseInt(btn.dataset.week) === w);
    });
    const amrapField = document.getElementById('qlAmrapField');
    const deloadNote = document.getElementById('qlDeloadNote');
    if (amrapField) amrapField.style.display = w === 4 ? 'none' : '';
    if (deloadNote) deloadNote.style.display = w === 4 ? '' : 'none';
    updateQuickLogPreview();
  }

  function updateQuickLogPreview() {
    const el = document.getElementById('qlPreview');
    if (!el) return;
    const day = data.days[qlState.dayIndex];
    const lift = data.lifts[day.mainLift];
    const working = getWorkingSets(lift.tm, qlState.week);
    const topSet = working[working.length - 1];

    const amrapEl = document.getElementById('qlAmrap');
    const reps = amrapEl ? parseInt(amrapEl.value) || 0 : 0;
    const e1rmHtml = reps > 0
      ? `<div style="margin-top:6px">Estimated 1RM: <span class="top-set">${estimate1RM(topSet.weight, reps)} ${data.settings.units}</span></div>`
      : '';

    el.innerHTML = `<div class="ql-summary">
      <span class="lift-name">${lift.name}</span>  TM ${lift.tm} ${data.settings.units}<br>
      Top set: <span class="top-set">${topSet.weight} ${data.settings.units} x ${topSet.reps}</span>
      ${e1rmHtml}
    </div>`;
  }

  function submitQuickLog() {
    const dateEl = document.getElementById('qlDate');
    const amrapEl = document.getElementById('qlAmrap');
    const logDate = dateEl ? dateEl.value : new Date().toISOString().slice(0, 10);
    if (!logDate || isNaN(new Date(logDate + 'T00:00:00').getTime())) {
      dateEl && (dateEl.style.borderColor = 'var(--danger)');
      return;
    }
    const amrapReps = amrapEl ? parseInt(amrapEl.value) || 0 : 0;

    const day = data.days[qlState.dayIndex];
    const lift = data.lifts[day.mainLift];
    const working = getWorkingSets(lift.tm, qlState.week);
    const suppSetsLog = getSupplementalSets(day.supplemental, qlState.week);

    const entry = {
      id: Date.now().toString(36),
      date: logDate,
      dayIndex: qlState.dayIndex,
      cycle: data.currentCycle,
      week: qlState.week,
      template: data.settings.template,
      quickLog: true,
      mainLift: {
        liftKey: day.mainLift,
        tm: lift.tm,
        amrapReps: amrapReps,
        sets: working.map(s => ({
          weight: s.weight, reps: s.reps, pct: s.pct, isAmrap: s.isAmrap,
        })),
      },
      supplemental: suppSetsLog.length > 0 ? {
        type: day.supplemental.type,
        liftKey: day.supplemental.liftKey,
        sets: suppSetsLog.map(s => ({ weight: s.weight, reps: s.reps })),
      } : null,
      accessories: [],
    };

    // Insert in date-sorted position so backdated entries don't corrupt e1RM estimates
    let insertIdx = data.log.length;
    for (let i = data.log.length - 1; i >= 0; i--) {
      if (data.log[i].date <= logDate) { insertIdx = i + 1; break; }
      if (i === 0) insertIdx = 0;
    }
    data.log.splice(insertIdx, 0, entry);
    save();
    closeModal();

    const topSet = working[working.length - 1];
    showModal(`<h3>Workout Logged!</h3>
      <p class="text-sm text-muted">${day.name} - Week ${qlState.week}, Cycle ${data.currentCycle}</p>
      <p class="text-xs text-muted">Logged via Quick Log for ${formatDate(logDate)}</p>
      ${amrapReps > 0 ? `<p class="mt-8">AMRAP: ${topSet.weight} x ${amrapReps}<br>
      <span class="text-warning fw-700">Estimated 1RM: ${estimate1RM(topSet.weight, amrapReps)} ${data.settings.units}</span></p>` : ''}
      <button class="btn btn-primary" onclick="App.closeModal()">OK</button>`);
  }

  function advanceCycle() {
    const opts = [0, 5, 10];
    showModal(`<h3>Advance to Cycle ${data.currentCycle + 1}?</h3>
      <p class="text-sm text-muted mb-8">Choose TM increase for each lift:</p>
      <div style="margin-bottom:16px">
        ${Object.entries(data.lifts).map(([k, l]) => {
          const defaultInc = l.type === 'upper' ? 5 : 5;
          return `<div class="flex-between" style="padding:6px 0;border-bottom:1px solid var(--card-border)">
            <div>
              <div class="text-sm fw-700">${l.name}</div>
              <div class="text-xs text-muted">${l.tm} lbs</div>
            </div>
            <select id="tmInc_${k}" style="width:90px;font-size:14px;padding:6px 8px"
                    onchange="App.previewAdvance()">
              ${opts.map(v => `<option value="${v}" ${v === defaultInc ? 'selected' : ''}>${v === 0 ? 'Keep' : '+' + v + ' lbs'}</option>`).join('')}
            </select>
          </div>`;
        }).join('')}
      </div>
      <div id="advancePreview" class="text-sm mb-16"></div>
      <div class="inline-btns">
        <button class="btn btn-outline" onclick="App.closeModal()">Cancel</button>
        <button class="btn btn-success" onclick="App.confirmAdvanceCycle()">Advance</button>
      </div>`);
    previewAdvance();
  }

  function previewAdvance() {
    const el = document.getElementById('advancePreview');
    if (!el) return;
    let html = '';
    for (const [k, l] of Object.entries(data.lifts)) {
      const sel = document.getElementById(`tmInc_${k}`);
      const inc = sel ? parseInt(sel.value) : 0;
      const newTM = l.tm + inc;
      const arrow = inc > 0 ? `<span class="text-success fw-700">${newTM}</span>` : `<span class="text-muted">${newTM}</span>`;
      html += `<div class="flex-between" style="padding:2px 0">
        <span class="text-sm">${l.name}</span>
        <span class="text-sm">${l.tm}  ${arrow}</span>
      </div>`;
    }
    el.innerHTML = html;
  }

  function confirmAdvanceCycle() {
    for (const [key, lift] of Object.entries(data.lifts)) {
      const sel = document.getElementById(`tmInc_${key}`);
      const inc = sel ? parseInt(sel.value) : 0;
      lift.tm += inc;
    }
    data.currentCycle++;
    data.currentWeek = 1;

    data.tmHistory.push({
      date: new Date().toISOString().slice(0, 10),
      bench: data.lifts.bench.tm,
      frontSquat: data.lifts.frontSquat.tm,
      ohp: data.lifts.ohp.tm,
      rdl: data.lifts.rdl.tm,
      cycle: data.currentCycle,
    });

    save();
    closeModal();
    render();
    renderSettings();
  }

  function updateTM(key, val) {
    data.lifts[key].tm = parseInt(val) || 0;
    save();
    render();
  }

  function toggleDeload(val) {
    data.settings.includeDeload = val === 'true';
    save();
    renderWeekSelector();
  }

  function setProgressRange(months) {
    progressMonths = months;
    renderProgress();
  }

  function editAccessories(dayIdx) {
    const day = data.days[dayIdx];
    let html = `<h3>Edit ${day.name} Accessories</h3>
      <div style="max-height:60vh;overflow-y:auto">`;
    day.accessories.forEach((acc, ai) => {
      html += `<div style="margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--card-border)">
        <div class="setting-row"><label>Name</label>
          <input type="text" id="accName_${dayIdx}_${ai}" value="${acc.name}" style="width:180px">
        </div>
        <div style="display:flex;gap:8px">
          <div class="setting-row" style="flex:1"><label>Sets</label>
            <input type="number" id="accSets_${dayIdx}_${ai}" value="${acc.sets}" min="1" max="10" style="width:50px">
          </div>
          <div class="setting-row" style="flex:1"><label>Low</label>
            <input type="number" id="accLow_${dayIdx}_${ai}" value="${acc.repsLow}" min="1" max="50" style="width:50px">
          </div>
          <div class="setting-row" style="flex:1"><label>High</label>
            <input type="number" id="accHigh_${dayIdx}_${ai}" value="${acc.repsHigh}" min="1" max="50" style="width:50px">
          </div>
        </div>
      </div>`;
    });
    html += `</div>
      <button class="btn btn-outline btn-sm mb-8" onclick="App.addAccessory(${dayIdx})">+ Add Exercise</button>
      <div class="inline-btns">
        <button class="btn btn-outline" onclick="App.closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="App.saveAccessories(${dayIdx})">Save</button>
      </div>`;
    showModal(html);
  }

  function addAccessory(dayIdx) {
    data.days[dayIdx].accessories.push({
      name: 'New Exercise', sets: 3, repsLow: 10, repsHigh: 12, lastWeight: 0, lastReps: [],
    });
    save();
    editAccessories(dayIdx);
  }

  function saveAccessories(dayIdx) {
    const day = data.days[dayIdx];
    day.accessories.forEach((acc, ai) => {
      const nameEl = document.getElementById(`accName_${dayIdx}_${ai}`);
      const setsEl = document.getElementById(`accSets_${dayIdx}_${ai}`);
      const lowEl = document.getElementById(`accLow_${dayIdx}_${ai}`);
      const highEl = document.getElementById(`accHigh_${dayIdx}_${ai}`);
      if (nameEl) acc.name = nameEl.value;
      if (setsEl) acc.sets = parseInt(setsEl.value) || 3;
      if (lowEl) acc.repsLow = parseInt(lowEl.value) || 8;
      if (highEl) acc.repsHigh = parseInt(highEl.value) || 12;
    });
    save();
    closeModal();
    renderWorkout();
    renderSettings();
  }

  // ===== TEMPLATE SWITCHING =====
  function openTemplateSelector() {
    let html = '<h3>Choose Template</h3><div class="template-grid">';
    for (const [key, tmpl] of Object.entries(TEMPLATES)) {
      const selected = key === data.settings.template ? 'selected' : '';
      html += `<div class="template-card ${selected}" onclick="App.confirmTemplatePick('${key}')">
        <div class="template-card-name">${tmpl.name}</div>
        <div class="template-card-desc">${tmpl.description}</div>
        <div class="template-card-days">${tmpl.daysPerWeek} days/week</div>
      </div>`;
    }
    html += '</div><button class="btn btn-outline" onclick="App.closeModal()">Cancel</button>';
    showModal(html);
  }

  function confirmTemplatePick(templateId) {
    if (templateId === data.settings.template) { closeModal(); return; }
    const tmpl = TEMPLATES[templateId];
    if (!tmpl) return;
    showModal(`<h3>Switch to ${tmpl.name}?</h3>
      <p class="text-sm text-muted mb-8">${tmpl.description}</p>
      <p class="text-sm mb-16">Your training maxes and history will be preserved. Cycle/week will reset to 1.</p>
      <div class="inline-btns">
        <button class="btn btn-outline" onclick="App.openTemplateSelector()">Back</button>
        <button class="btn btn-primary" onclick="App.applyTemplate('${templateId}')">Switch</button>
      </div>`);
  }

  function applyTemplate(templateId) {
    const tmpl = TEMPLATES[templateId];
    if (!tmpl) return;
    // Deep clone the template days so we don't mutate the constant
    data.days = JSON.parse(JSON.stringify(tmpl.days));
    data.settings.template = templateId;
    data.currentWeek = 1;
    data.selectedDay = 0;
    workoutInProgress = {};
    save();
    closeModal();
    render();
    renderSettings();
  }

  // ===== DATA MANAGEMENT =====
  function exportData() {
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `531tracker_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function importData(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const imported = JSON.parse(e.target.result);
        if (imported.lifts && imported.days) {
          data = imported;
          save();
          render();
          renderSettings();
          showModal('<h3>Import Successful</h3><p>Your data has been imported.</p><button class="btn btn-primary" onclick="App.closeModal()">OK</button>');
        } else {
          alert('Invalid data format');
        }
      } catch (err) { alert('Error reading file: ' + err.message); }
    };
    reader.readAsText(file);
  }

  function resetData() {
    showModal(`<h3>Reset All Data?</h3>
      <p class="text-sm text-muted mb-16">This cannot be undone. All workout history, TMs, and settings will be reset to defaults.</p>
      <div class="inline-btns">
        <button class="btn btn-outline" onclick="App.closeModal()">Cancel</button>
        <button class="btn btn-danger" onclick="App.confirmReset()">Reset</button>
      </div>`);
  }

  function confirmReset() {
    localStorage.removeItem('531tracker');
    workoutInProgress = {};
    load();
    closeModal();
    render();
    renderSettings();
  }

  // ===== MODAL =====
  function showModal(html) {
    document.getElementById('modalContent').innerHTML = html;
    document.getElementById('modalOverlay').classList.add('show');
  }
  function closeModal() {
    document.getElementById('modalOverlay').classList.remove('show');
  }

  // ===== HISTORY TOGGLE =====
  function toggleHistory(idx) {
    const el = document.getElementById(`histDetail_${idx}`);
    if (el) el.classList.toggle('open');
  }

  // ===== HELPERS =====
  function formatDate(dateStr) {
    const d = new Date(dateStr + 'T12:00:00');
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }

  // ===== TAB NAVIGATION =====
  function switchTab(tabId) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
    document.getElementById('mainContent').scrollTop = 0;

    if (tabId === 'viewHistory') renderHistory();
    if (tabId === 'viewProgress') renderProgress();
    if (tabId === 'viewSettings') renderSettings();
  }

  // ===== INIT =====
  function init() {
    load();

    // Tab navigation
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    // Close modal on overlay click
    document.getElementById('modalOverlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeModal();
    });

    render();

    // Recover persisted timer from localStorage
    const saved = loadPersistedTimer();
    if (saved) {
      const elapsed = Date.now() - saved.endTime;
      if (elapsed > 10 * 60 * 1000) {
        // Timer expired more than 10 minutes ago  discard
        clearPersistedTimer();
      } else {
        timerEndTime = saved.endTime;
        timerHasVibrated = saved.hasVibrated || false;
        const remaining = getTimerRemaining();
        document.getElementById('timerOverlay').classList.add('show');
        document.body.classList.add('timer-active');
        updateTimerDisplay(remaining);
        if (remaining <= 0 && !timerHasVibrated) {
          timerHasVibrated = true;
          persistTimer();
          if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }
        timerInterval = setInterval(timerTick, 1000);
      }
    }

    // Re-sync timer when app returns to foreground
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && timerEndTime > 0) {
        const remaining = getTimerRemaining();
        updateTimerDisplay(remaining);
        if (remaining <= 0 && !timerHasVibrated) {
          timerHasVibrated = true;
          persistTimer();
          if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }
        // Restart interval defensively  OS may have killed it
        clearInterval(timerInterval);
        timerInterval = setInterval(timerTick, 1000);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', init);

  // Register Service Worker for offline/PWA
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  }

  // Public API
  return {
    selectDay, setWeek, setCycle, toggleSet, toggleSupp, setAmrap, setAccWeight, setAccRep,
    logWorkout, advanceCycle, previewAdvance, confirmAdvanceCycle, updateTM, toggleDeload,
    editAccessories, addAccessory, saveAccessories, toggleHistory, setProgressRange,
    openTemplateSelector, confirmTemplatePick, applyTemplate,
    showQuickLog, qlSetDay, qlSetWeek, updateQuickLogPreview, submitQuickLog,
    startTimer, stopTimer, addTime,
    exportData, importData, resetData, confirmReset,
    showModal, closeModal,
  };
})();
</script>
</body>
</html>
